# Server

Server-only code: database schemas, services, and auth configuration. Everything here runs exclusively on the server (imported via `$lib/server/`).

## db/ — Database Schemas (Drizzle ORM)

Three Postgres schemas, all managed by Drizzle:

### `public` schema (`schema.ts`)

App-level tables alongside Better Auth's auto-generated tables:

- `anonymous_session` — Cookie-based anonymous tracking (custom, NOT Better Auth plugin)
- `user_settings` — Persisted settings for authenticated users (theme, characterSet)
- `user_email` — Maps secondary emails → primary user ID (for Meteor migration multi-email login)
- `user_permission` — Permission grants per user (e.g. `wikiEdit`). Unique on (userId, permission).

### `stage` schema (`stage.schema.ts`)

Raw imported data from external sources. Never queried by the app directly — used for data exploration and to feed `dictionary` schema.

- `unihan_raw` — Unicode Unihan (EAV format, 1.56M rows, 99 fields)
- `cedict_raw` — CC-CEDICT (124k word entries)
- `dong_char_raw`, `dong_word_raw`, `dong_history_raw` — Dong Chinese MongoDB wiki exports (JSONB)
- `animcjk_raw`, `makemeahanzi_raw` — Stroke order data
- `shuowen_raw` — Etymology (Shuowen Jiezi)
- `baxter_sagart`, `zhengzhang` — Historical pronunciation reconstructions
- `jun_da`, `subtlex_ch` — Character/word frequency corpora
- `sync_metadata` — Tracks import checksums for idempotency

### `dictionary` schema (`dictionary.schema.ts` + `dictionary.views.ts`)

Denormalized data serving app queries:

- `char_base` — Base character table, materialized from all stage sources by `scripts/dictionary/rebuild-dict-char.ts`
- `char_manual` — Append-only edit log. Full-row snapshots with `status` (pending/approved/rejected), reviewer info, and audit columns. Anyone can suggest edits; `wikiEdit` users get auto-approved and can approve/reject others.
- `char` (view) — Overlays the latest approved `char_manual` edit on top of `char_base` via COALESCE. SQL defined once in `char-view-sql.ts`, used by `dictionary.views.ts` (drizzle-managed `.as()`), `rebuild-dict-char.ts` (atomic swap), and `create-char-view.ts` (standalone creation).

### `auth.schema.ts`

Auto-generated by Better Auth CLI. Tables: `user`, `session`, `account`, `verification`.

### `index.ts`

Creates the Drizzle `db` instance using `postgres.js` driver and re-exports all schemas.

## services/ — Business Logic

| Service                | Purpose                                                                                                                                                                                                                                                                                              |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `anonymous-session.ts` | Create/validate/delete anonymous sessions. Custom cookie + DB row.                                                                                                                                                                                                                                   |
| `char-edit.ts`         | Submit/approve/reject character edits. `submitCharEdit()`, `updateCharEdit()`, `approveCharEdit()`, `rejectCharEdit()`, `getPendingEdits()`, `getUserPendingEdit()`, `getUserPendingEdits()`, `getCharEditHistory()`, `countPendingEdits()`, `countAllPendingEdits()`. Recent edits exclude pending. |
| `dictionary.ts`        | `getCharacterData()` loads a character from the `dictionary.char` view + batch-loads component data.                                                                                                                                                                                                 |
| `email.ts`             | Nodemailer wrapper. Logs to console when MAIL_URL not set (dev mode).                                                                                                                                                                                                                                |
| `magic-link.ts`        | Generates + verifies magic links. Resolves secondary emails.                                                                                                                                                                                                                                         |
| `permissions.ts`       | `hasPermission()`, `getUserPermissions()` — queries `user_permission` table.                                                                                                                                                                                                                         |
| `sanitize-redirect.ts` | Prevents open redirects — only allows relative paths.                                                                                                                                                                                                                                                |
| `settings.ts`          | Read/write settings from JSON cookie + DB. `applySettings()`, `syncSettingsOnLogin()`, `syncSettingsOnSignup()`.                                                                                                                                                                                     |

## auth.ts — Better Auth Configuration

Key customizations:

- **Bcrypt override**: SHA256 → bcrypt, compatible with Meteor's `$2a$`/`$2b$` hashes
- **Plugins**: `magicLink` (defers email to form action), `username` (login detects email vs username by `@`)
- **OAuth**: GitHub, Google, Facebook — conditionally enabled via env vars, server-side redirects (no JS)
- **Database hooks**: After user create, populates `user_email` table for secondary email resolution

## Request Lifecycle (hooks.server.ts)

Three sequential handlers on every request:

1. **Better Auth** → populates `locals.user`, `locals.session`
2. **Anonymous Session** → creates/validates cookie + DB row (skips if authenticated)
3. **Settings** → loads from DB (authenticated) or cookie (anonymous), injects `data-theme` via `transformPageChunk`
